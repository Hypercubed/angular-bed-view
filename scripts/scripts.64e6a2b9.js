"use strict";angular.module("angularBedViewApp",["ui.codemirror","angularprimer","hc.downloader","hc.dsv"]),angular.module("angularBedViewApp").controller("MainCtrl",["$scope","dsv","$http",function(a,b,c){function d(a){if(!a||0===a.length)return 0;var b=d3.select("body").append("svg"),c=b.append("text");c.text(a);var d=c.node().getComputedTextLength();return b.remove(),d}function e(a){if(a.chromStart=+a.chromStart,a.chromEnd=+a.chromEnd,a.itemRgb=a.itemRgb||"0,0,0",a.shape="box",a.blocks=[],a.thickStart=a.thickStart||a.chromStart,a.thickEnd=a.thickEnd||a.chromEnd,a.blockCount&&a.blockCount>0){a.blockSizes=a.blockSizes.split(","),a.blockStarts=a.blockStarts.split(","),a.blockCount=parseInt(a.blockCount);for(var b=0;b<a.blockCount;b++){var c=a.blockStarts[b];c&&(c=a.chromStart+parseInt(c),a.blocks.push({start:c,end:c+parseInt(a.blockSizes[b])}))}}else a.blocks.push({start:a.thickStart,end:a.thickEnd});return a.labelWidth=d(a.name),a.strand&&(a.shape+="+"===a.strand?"-right":"-left"),a}function f(a){g.bedArray=d3.nest().key(k).entries(a),g.bedArray.forEach(function(a,b){a.start=d3.min(a.values,i),a.length=d3.max(a.values,j)-a.start,a.height=40+l(a.values.length),a.labelWidth=d3.max(a.values,h),a.labelWidth=Math.max(a.labelWidth,d(a.key||"")),a.offset=0===b?0:g.bedArray[b-1].height+g.bedArray[b-1].offset}),g.margin={top:30,right:0,bottom:0,left:d3.max(g.bedArray,h)},g.svgHeight=g.bedArray[g.bedArray.length-1].offset+g.bedArray[g.bedArray.length-1].height,g.trackWidth=650-g.margin.left-g.margin.right,g.bedForm.$setPristine()}var g=this;g.bedText=null;var h=_F("labelWidth"),i=_F("chromStart"),j=_F("chromEnd"),k=_F("chrom"),l=a.yScale=function(a){return 11*a};g.load=function(a){if(a.length){var d={method:"get",url:a,cache:!0};b.tsv(d,e).success(f),c(d).success(function(a){g.bedText=a})}};var m="chrom	chromStart	chromEnd	name	score	strand	thickStart	thickEnd	itemRgb	blockCount	blockSizes	blockStarts\n";g.process=function(a){if(a=a||g.bedText){a=a.replace(/[ \t\xA0\u00A0\u2028\u2029]+/g,"	"),a.match(/^chrom/)||(a=m+a);var c=b.tsv.parse(a,e);f(c)}},g.onRead=function(a){g.bedText=a.target.result,g.process()}}]);